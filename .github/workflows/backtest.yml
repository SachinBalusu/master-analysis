name: Run Backtest

on:
  workflow_dispatch:
    inputs:
      config_file:
        description: 'Config file path (relative to repo root)'
        required: true
        default: 'master-analysis/kes-scanner/backtesting/configs/quick_test.json'
        type: choice
        options:
          - master-analysis/kes-scanner/backtesting/configs/quick_test.json
          - master-analysis/kes-scanner/backtesting/configs/all_strategies.json
          - master-analysis/kes-scanner/backtesting/configs/averaging_down.json
      python_version:
        description: 'Python version'
        required: false
        default: '3.11'
        type: string

jobs:
  backtest:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ inputs.python_version }}
        cache: 'pip'

    - name: Install dependencies
      working-directory: master-analysis/kes-scanner
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set up Cloud SQL Proxy
      run: |
        curl -o cloud-sql-proxy https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.8.0/cloud-sql-proxy.linux.amd64
        chmod +x cloud-sql-proxy
        ./cloud-sql-proxy --port 5432 ${{ secrets.CLOUD_SQL_INSTANCE }} &
        sleep 5

    - name: Wait for database connection
      run: |
        for i in {1..30}; do
          if pg_isready -h localhost -p 5432 -U ${{ secrets.DB_USER }}; then
            echo "Database is ready"
            exit 0
          fi
          echo "Waiting for database... ($i/30)"
          sleep 2
        done
        echo "Database connection timeout"
        exit 1
      env:
        PGPASSWORD: ${{ secrets.DB_PASSWORD }}

    - name: Run backtest
      working-directory: master-analysis/kes-scanner
      run: |
        python backtesting/scripts/run_backtest.py ../../${{ inputs.config_file }}
      env:
        DB_HOST: localhost
        DB_PORT: 5432
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    - name: Generate HTML report
      if: always()
      working-directory: master-analysis/kes-scanner
      run: |
        python backtesting/scripts/generate_html_report.py backtesting/results backtest_report.html
        mv backtesting/results/backtest_report.html backtest_report.html

    - name: Upload HTML report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backtest-html-report-${{ github.run_number }}
        path: master-analysis/kes-scanner/backtest_report.html
        retention-days: 90

    - name: Upload results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backtest-results-${{ github.run_number }}
        path: |
          master-analysis/kes-scanner/backtesting/results/*.csv
          master-analysis/kes-scanner/backtesting/results/*.png
          master-analysis/kes-scanner/logs/*.log
        retention-days: 90

    - name: Generate visual summary
      if: always()
      working-directory: master-analysis/kes-scanner
      run: |
        echo "# ðŸ“Š Backtest Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Config File:** \`${{ inputs.config_file }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Python Version:** ${{ inputs.python_version }}" >> $GITHUB_STEP_SUMMARY
        echo "**Run Number:** #${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Display comparison report as markdown table
        if [ -f backtesting/results/comparison_report.csv ]; then
          echo "## ðŸ“ˆ Performance Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Convert CSV to markdown table
          python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
        import csv
        import sys
        
        try:
            with open('backtesting/results/comparison_report.csv', 'r') as f:
                reader = csv.reader(f)
                rows = list(reader)
                
                if len(rows) > 0:
                    # Header
                    print('| ' + ' | '.join(rows[0]) + ' |')
                    print('|' + '|'.join(['---' for _ in rows[0]]) + '|')
                    
                    # Data rows
                    for row in rows[1:]:
                        print('| ' + ' | '.join(row) + ' |')
        except Exception as e:
            print(f"Error reading CSV: {e}")
        EOF
          
          echo "" >> $GITHUB_STEP_SUMMARY
        fi
        
        # List all generated charts
        echo "## ðŸŽ¨ Generated Charts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        CHART_COUNT=$(ls -1 backtesting/results/*.png 2>/dev/null | wc -l)
        if [ $CHART_COUNT -gt 0 ]; then
          echo "âœ… Generated $CHART_COUNT chart(s)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for chart in backtesting/results/*.png; do
            if [ -f "$chart" ]; then
              CHART_NAME=$(basename "$chart" .png)
              echo "- ðŸ“Š **$CHART_NAME**" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ï¿½ **Note:** Download the artifacts below to view the actual chart images" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No charts generated" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Add trade statistics if available
        if [ -f backtesting/results/comparison_report.csv ]; then
          echo "## ï¿½ Key Metrics" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Extract and display best performing scenario
          python3 << 'EOF' >> $GITHUB_STEP_SUMMARY
        import csv
        
        try:
            with open('backtesting/results/comparison_report.csv', 'r') as f:
                reader = csv.DictReader(f)
                rows = list(reader)
                
                if len(rows) > 0:
                    # Find best return
                    best_return = max(rows, key=lambda x: float(x.get('Total Return (%)', 0)))
                    # Find best win rate
                    best_win_rate = max(rows, key=lambda x: float(x.get('Win Rate (%)', 0)))
                    # Find best Sharpe
                    best_sharpe = max(rows, key=lambda x: float(x.get('Sharpe Ratio', 0)))
                    
                    print(f"### ðŸ† Best Performers")
                    print("")
                    print(f"- **Highest Return:** {best_return.get('Scenario', 'N/A')} ({best_return.get('Total Return (%)', 'N/A')}%)")
                    print(f"- **Highest Win Rate:** {best_win_rate.get('Scenario', 'N/A')} ({best_win_rate.get('Win Rate (%)', 'N/A')}%)")
                    print(f"- **Best Risk-Adjusted:** {best_sharpe.get('Scenario', 'N/A')} (Sharpe: {best_sharpe.get('Sharpe Ratio', 'N/A')})")
                    print("")
        except Exception as e:
            print(f"Could not analyze metrics: {e}")
        EOF
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ï¿½ðŸ“¦ Download Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ HTML Report (Recommended)" >> $GITHUB_STEP_SUMMARY
        echo "Download **backtest-html-report-${{ github.run_number }}** for:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“Š Interactive HTML report with embedded charts" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¨ All visualizations in one beautiful page" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“± Mobile-friendly responsive design" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Raw Data" >> $GITHUB_STEP_SUMMARY
        echo "Download **backtest-results-${{ github.run_number }}** for:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“„ CSV files with trade-by-trade data" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ–¼ï¸ PNG charts (4-panel visualizations)" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“ Log files for debugging" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Retention:** 90 days" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ’¡ **Pro Tip:** Open the HTML report in your browser to see all charts and data in one place!" >> $GITHUB_STEP_SUMMARY
